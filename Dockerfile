FROM openjdk:17-alpine

ARG PROFILE
ARG DB_PROD_HOST
ARG DB_PROD_USERNAME
ARG DB_PROD_PASSWD
ARG SOCIAL_CLIENT_ID
ARG SOCIAL_CLIENT_PASSWD
ARG SOCIAL_CLIENT_SECRET
ARG JWT_SECRET
ARG DEFAULT_PROFILE
ARG AWS_CLOUDFRONT_DOMAIN

ENV PROFILE=${PROFILE}
ENV DB_PROD_HOST=${DB_PROD_HOST}
ENV DB_PROD_USERNAME=${DB_PROD_USERNAME}
ENV AWS_CLOUDFRONT_DOMAIN=${AWS_CLOUDFRONT_DOMAIN}
ENV DB_PROD_PASSWD=${DB_PROD_PASSWD}
ENV SOCIAL_CLIENT_ID=${SOCIAL_CLIENT_ID}
ENV SOCIAL_CLIENT_PASSWD=${SOCIAL_CLIENT_PASSWD}
ENV SOCIAL_CLIENT_SECRET=${SOCIAL_CLIENT_SECRET}
ENV JWT_SECRET=${JWT_SECRET}
ENV DEFAULT_PROFILE=${DEFAULT_PROFILE}

# Install Redis
RUN apk update && \
    apk add redis

# Copy application JAR
ARG JAR_PATH=build/libs/*.jar
COPY ${JAR_PATH} /home/server.jar

# Expose ports
EXPOSE 8080 6379

# Entry point
ENTRYPOINT sh -c "redis-server --daemonize yes && java -jar /home/server.jar"
